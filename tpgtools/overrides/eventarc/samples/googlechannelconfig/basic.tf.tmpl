data "google_project" "test_project" {
	project_id  = "{{project-id}}"
}

data "google_kms_key_ring" "test_key_ring" {
	name     = "{{keyring}}"
	location = "{{region}}"
}
  
data "google_kms_crypto_key" "key" {
	name     = "{{key}}"
	key_ring = data.google_kms_key_ring.test_key_ring.id
}

resource "google_kms_crypto_key_iam_binding" "key_binding" {
    crypto_key_id = data.google_kms_crypto_key.key.id
    role      = "roles/cloudkms.cryptoKeyEncrypterDecrypter"
  
    members = [
    "serviceAccount:service-${data.google_project.test_project.number}@gcp-sa-eventarc.iam.gserviceaccount.com",
    ]
}

resource "google_eventarc_google_channel_config" "channel_config" {
  location = "{{region}}"
  name     = "projects/{{project-id}}/locations/{{region}}/googleChannelConfig"
  project  = "${data.google_project.test_project.project_id}"
  crypto_key_name =  "${data.google_kms_crypto_key.key.id}"
  depends_on = [google_kms_crypto_key_iam_binding.key1_binding]
}
